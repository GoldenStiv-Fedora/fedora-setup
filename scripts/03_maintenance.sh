#!/bin/bash
# 03_maintenance.sh ‚Äî –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã Fedora Auto-Setup

CONFIG_FILE="/etc/fedora-setup.conf"
[ -f "$CONFIG_FILE" ] || { echo "‚ùå –ö–æ–Ω—Ñ–∏–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω!"; exit 1; }
source "$CONFIG_FILE"

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
LOG_DIR="/var/log/fedora-auto-setup"
mkdir -p "$LOG_DIR"
exec > >(tee -a "$LOG_DIR/maintenance-$(date +%F).log") 2>&1

echo "=== –°—Ç–∞—Ä—Ç –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ ==="

# –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
ping -c 3 8.8.8.8 &>/dev/null
if [[ $? -eq 0 ]]; then
    echo "‚úÖ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω"
else
    echo "‚ùå –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É!"
    notify-send "Fedora Setup" "–í–Ω–∏–º–∞–Ω–∏–µ: –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É!"
    exit 1
fi

# –®–∞–≥ 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã..."
dnf upgrade -y

# –®–∞–≥ 3: –°–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–ª—É–∂–±
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–ª—É–∂–±—ã auto-setup..."
systemctl is-active --quiet fedora-auto-setup.service && echo "‚úÖ –°–ª—É–∂–±–∞ –∞–∫—Ç–∏–≤–Ω–∞" || echo "‚ùå –°–ª—É–∂–±–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞"

# –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–µ–∂–µ—Å—Ç–∏ —Å–∫—Ä–∏–ø—Ç–æ–≤
echo "üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–æ–≤..."
bash /usr/local/bin/00_fetch_logs.sh
bash /usr/local/bin/01_analyze_and_prepare.sh
source /tmp/system_config_detected.conf

# –®–∞–≥ 5: –°–∞–º–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
bash /usr/local/bin/02_full_auto_setup.sh --update-only

# –®–∞–≥ 6: –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
notify-send "Fedora Setup" "‚úÖ –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –°–∏—Å—Ç–µ–º–∞ –≤ –ø–æ—Ä—è–¥–∫–µ."

echo "=== –°–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ ==="
