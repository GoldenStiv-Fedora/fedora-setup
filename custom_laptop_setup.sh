#!/bin/bash

#####################################################################
#   –£–õ–¨–¢–ò–ú–ê–¢–ò–í–ù–´–ô –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –°–ö–†–ò–ü–¢ –ù–ê–°–¢–†–û–ô–ö–ò FEDORA –î–õ–Ø –ù–û–£–¢–ë–£–ö–ê #
#             –ü–æ–ª–Ω–∞—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ    #
# –í–µ—Ä—Å–∏—è: 7.1                                                       #
# –¢—Ä–µ–±—É–µ—Ç—Å—è: root-–¥–æ—Å—Ç—É–ø                                            #
#####################################################################

# --------------------------
# üîÑ –°–∞–º–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞
# --------------------------
SCRIPT_URL="https://raw.githubusercontent.com/GoldenStiv-Fedora/fedora-setup/main/custom_laptop_setup.sh"
LOCAL_SCRIPT="/root/custom_laptop_setup.sh"
TMP_SCRIPT="/tmp/custom_laptop_setup_latest.sh"

if curl -s --output "$TMP_SCRIPT" --fail "$SCRIPT_URL"; then
    if ! cmp -s "$LOCAL_SCRIPT" "$TMP_SCRIPT"; then
        echo "üÜï –ù–∞–π–¥–µ–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —Å–∫—Ä–∏–ø—Ç–∞! –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ..."
        cp "$TMP_SCRIPT" "$LOCAL_SCRIPT"
        chmod +x "$LOCAL_SCRIPT"
        notify-send "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞" "–°–∫—Ä–∏–ø—Ç –±—ã–ª –æ–±–Ω–æ–≤–ª–µ–Ω. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫..."
        exec "$LOCAL_SCRIPT"
        exit 0
    else
        echo "‚úÖ –°–∫—Ä–∏–ø—Ç –∞–∫—Ç—É–∞–ª–µ–Ω."
        rm -f "$TMP_SCRIPT"
    fi
else
    echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–µ–π."
fi

# --------------------------
# üìÖ –ê–≤—Ç–æ–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–∫—Ä–∏–ø—Ç–∞ —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é
# --------------------------
(crontab -l 2>/dev/null; echo "0 12 * * 1 DISPLAY=:0 DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/$(id -u)/bus notify-send '–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ' '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ Fedora Setup!'") | crontab -u $(whoami) -

# --------------------------
# üõ°Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ root-–¥–æ—Å—Ç—É–ø–∞
# --------------------------
if [[ $EUID -ne 0 ]]; then
    echo "‚õî –¢—Ä–µ–±—É—é—Ç—Å—è –ø—Ä–∞–≤–∞ root!"
    exit 1
fi

FEDORA_VERSION=$(rpm -E %fedora)
echo "üìã –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ Fedora –≤–µ—Ä—Å–∏–∏: $FEDORA_VERSION"

# --------------------------
# üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
# --------------------------
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞–∫–µ—Ç–æ–≤ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞..."
dnf install -y powertop tuned thermald lm_sensors irqbalance nvme-cli smartmontools audit fprintd pipewire pipewire-pulseaudio pipewire-alsa wireplumber dnf-automatic libnotify cronie || {
    echo "‚ö†Ô∏è –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–∞–∑–æ–≤—ã—Ö –ø–∞–∫–µ—Ç–æ–≤!";
}

# --------------------------
# üî• –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã CPU –∏ NVMe-–¥–∏—Å–∫–∞
# --------------------------
echo "üî• –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –∏ —ç–Ω–µ—Ä–≥–æ–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è..."
systemctl enable --now thermald.service irqbalance.service tuned.service || echo "‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ —Å –≤–∫–ª—é—á–µ–Ω–∏–µ–º —Ç–µ—Ä–º–∞–ª–¥ –∏–ª–∏ irqbalance"
tuned-adm profile powersave || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å powersave"

# --------------------------
# üöÄ –£—Å–∫–æ—Ä–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã DNF
# --------------------------
echo "üöÄ –£—Å–∫–æ—Ä–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã DNF..."
sed -i 's/^#fastestmirror=1/fastestmirror=1/' /etc/dnf/dnf.conf
sed -i 's/^#max_parallel_downloads=.*/max_parallel_downloads=10/' /etc/dnf/dnf.conf
sed -i 's/^#deltarpm=1/deltarpm=true/' /etc/dnf/dnf.conf

# --------------------------
# üîí –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ç–ø–µ—á–∞—Ç–∫–∞ –ø–∞–ª—å—Ü–∞
# --------------------------
echo "üîí –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ç–ø–µ—á–∞—Ç–∫–∞ –ø–∞–ª—å—Ü–∞..."
if fprintd-list $(whoami); then
    echo "‚úÖ –û—Ç–ø–µ—á–∞—Ç–æ–∫ —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω."
else
    echo "‚ö†Ô∏è –ù–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ—Ç–ø–µ—á–∞—Ç–∫–æ–≤. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: fprintd-enroll –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏."
fi

# --------------------------
# üéµ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PipeWire –¥–ª—è –∑–≤—É–∫–∞
# --------------------------
echo "üéµ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PipeWire –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –∑–≤—É–∫–∞..."
systemctl --user enable --now pipewire.service pipewire-pulse.service || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å PipeWire"

# --------------------------
# üìà –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã
# --------------------------
echo "üìà –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã..."
systemctl enable --now dnf-automatic.timer

cat <<EOF > /etc/dnf/automatic.conf
[commands]
upgrade_type = default
download_updates = yes
apply_updates = yes
[emitters]
emit_via = motd
emit_via = notify
EOF

# --------------------------
# üì° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–µ—Ç–µ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
# --------------------------
echo "üì° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è TCP-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π..."
cat <<EOF > /etc/sysctl.d/99-network-tuning.conf
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216
net.ipv4.tcp_congestion_control = bbr
EOF
sysctl --system || echo "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å–µ—Ç–µ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫"

# --------------------------
# üîç –í–∫–ª—é—á–µ–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–∏—Å–∫–æ–≤
# --------------------------
echo "üîç –í–∫–ª—é—á–µ–Ω–∏–µ SMART-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –¥–∏—Å–∫–æ–≤..."
systemctl enable --now smartd.service || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å smartd"

# --------------------------
# üîã –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã –±–∞—Ç–∞—Ä–µ–∏
# --------------------------
echo "üîã –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è —ç–Ω–µ—Ä–≥–æ—Å–±–µ—Ä–µ–∂–µ–Ω–∏—è..."
cat <<'EOF' > /etc/cron.hourly/battery-profile-switcher
#!/bin/bash
battery_status=$(cat /sys/class/power_supply/BAT*/status)
if [[ "$battery_status" == "Discharging" ]]; then
  tuned-adm profile powersave
  notify-send "–†–µ–∂–∏–º –±–∞—Ç–∞—Ä–µ–∏" "–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω —ç–Ω–µ—Ä–≥–æ—Å–±–µ—Ä–µ–≥–∞—é—â–∏–π –ø—Ä–æ—Ñ–∏–ª—å."
else
  tuned-adm profile balanced
  notify-send "–†–µ–∂–∏–º –ø–∏—Ç–∞–Ω–∏—è" "–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å."
fi
EOF
chmod +x /etc/cron.hourly/battery-profile-switcher

# --------------------------
# üõ°Ô∏è –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã
# --------------------------
echo "üõ°Ô∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–π —Å–∞–º–æ–ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏—Å—Ç–µ–º—ã..."
cat <<'EOF' > /etc/cron.weekly/system-health-check
#!/bin/bash
smartctl -H /dev/nvme0 || true
sensors || true
notify-send "–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞" "–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏—Å–∫–∞ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã."
EOF
chmod +x /etc/cron.weekly/system-health-check

# --------------------------
# üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
# --------------------------
echo "üßπ –û—á–∏—Å—Ç–∫–∞ –Ω–µ–Ω—É–∂–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
rm -rf /home/fedora-log-ultimate || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –ª–æ–≥–∏"

# --------------------------
# üèÅ –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è
# --------------------------
echo "‚úÖ –í—Å–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–æ—É—Ç–±—É–∫ –¥–ª—è –ø–æ–ª–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫."
notify-send "Fedora –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞" "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–∏—Å—Ç–µ–º—É."

