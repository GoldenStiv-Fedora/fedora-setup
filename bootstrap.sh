#!/usr/bin/env bash
# ==============================================
# JAJA Agent Bootstrap Script
# –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º—ã –∫ —É—Å—Ç–∞–Ω–æ–≤–∫–µ JAJA Agent
# –û–ø–∏—Å–∞–Ω–∏–µ:
#   1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (curl, git, gpg, sudo)
#   2. –°–∫–∞—á–∏–≤–∞–µ—Ç –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª
#   3. –ö–ª–æ–Ω–∏—Ä—É–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –ø—Ä–æ–µ–∫—Ç–∞
#   4. –ó–∞–ø—É—Å–∫–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏
# –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
#   - –ü–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å
#   - –ó–∞—â–∏—â–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
#   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã –ø–µ—Ä–µ–¥ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π
# ==============================================

set -euo pipefail

# –¶–≤–µ—Ç–∞ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# ----------------------------------------------
# –§—É–Ω–∫—Ü–∏—è: error
# –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –í—ã–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞
# –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
#   $1 - –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
# –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
#   –ö–æ–¥ –≤—ã—Ö–æ–¥–∞ 1
# ----------------------------------------------
error() {
  echo -e "${RED}[–û–®–ò–ë–ö–ê]${NC} $1" >&2
  exit 1
}

# ----------------------------------------------
# –§—É–Ω–∫—Ü–∏—è: warning
# –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –í—ã–≤–æ–¥ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
# –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
#   $1 - –¢–µ–∫—Å—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
# ----------------------------------------------
warning() {
  echo -e "${YELLOW}[–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï]${NC} $1"
}

# ----------------------------------------------
# –§—É–Ω–∫—Ü–∏—è: success
# –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –í—ã–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± —É—Å–ø–µ—à–Ω–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏
# –ê—Ä–≥—É–º–µ–Ω—Ç—ã:
#   $1 - –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
# ----------------------------------------------
success() {
  echo -e "${GREEN}[–£–°–ü–ï–•]${NC} $1"
}

# ----------------------------------------------
# –§—É–Ω–∫—Ü–∏—è: check_dependencies
# –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
# –û–ø–∏—Å–∞–Ω–∏–µ:
#   –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ curl, git, gpg –∏ sudo –≤ —Å–∏—Å—Ç–µ–º–µ
#   –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ - –ø—ã—Ç–∞–µ—Ç—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ dnf
# –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
#   0 - –µ—Å–ª–∏ –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω—ã
#   1 - –ø—Ä–∏ –æ—à–∏–±–∫–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
# ----------------------------------------------
check_dependencies() {
  local deps=("curl" "git" "gpg" "sudo")
  local missing=()

  echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
  for dep in "${deps[@]}"; do
    if ! command -v "$dep" &>/dev/null; then
      missing+=("$dep")
    fi
  done

  if [[ ${#missing[@]} -gt 0 ]]; then
    warning "–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: ${missing[*]}"
    echo "üîÑ –ü–æ–ø—ã—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –ø–∞–∫–µ—Ç–æ–≤..."
    
    if command -v dnf &>/dev/null; then
      sudo dnf install -y "${missing[@]}" || error "–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
    else
      error "–ù–µ –Ω–∞–π–¥–µ–Ω –ø–∞–∫–µ—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä dnf. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é: ${missing[*]}"
    fi
  fi
  success "–í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω—ã"
}

# ----------------------------------------------
# –§—É–Ω–∫—Ü–∏—è: setup_config
# –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
# –û–ø–∏—Å–∞–Ω–∏–µ:
#   1. –°–∫–∞—á–∏–≤–∞–µ—Ç –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ —Å GitHub
#   2. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–∞—Ä–æ–ª—å –¥–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏
#   3. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ /etc/jaja.conf —Å –ø—Ä–∞–≤–∞–º–∏ 600
# –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
#   - –ü–∞—Ä–æ–ª—å –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏ –∫–æ–º–∞–Ω–¥
#   - –ö–æ–Ω—Ñ–∏–≥ –∑–∞—â–∏—â–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
# ----------------------------------------------
setup_config() {
  local config_url="https://raw.githubusercontent.com/GoldenStiv-Fedora/jaja-agent/main/configs/jaja.conf.gpg"
  local config_dir="/etc"
  local config_file="$config_dir/jaja.conf"

  echo "üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∞–≥–µ–Ω—Ç–∞..."
  
  # –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –∫–æ–Ω—Ñ–∏–≥–∞
  sudo mkdir -p "$config_dir"
  
  # –ó–∞–ø—Ä–æ—Å –ø–∞—Ä–æ–ª—è –∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞
  echo -n "–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –∫–æ–Ω—Ñ–∏–≥–∞: "
  read -rs password
  echo
  
  echo "üì• –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
  if ! curl -sL "$config_url" | sudo gpg --batch --passphrase "$password" --decrypt -o "$config_file" 2>/dev/null; then
    unset password
    error "–û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –∫–æ–Ω—Ñ–∏–≥–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–∞—Ä–æ–ª—å –∏–ª–∏ —Ñ–∞–π–ª."
  fi
  unset password
  
  # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –ø—Ä–∞–≤
  sudo chmod 600 "$config_file"
  success "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ $config_file"
}

# ----------------------------------------------
# –§—É–Ω–∫—Ü–∏—è: clone_project
# –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞
# –û–ø–∏—Å–∞–Ω–∏–µ:
#   –ö–ª–æ–Ω–∏—Ä—É–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤ /home/jaja-agent
#   –ï—Å–ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
# ----------------------------------------------
clone_project() {
  local install_dir="/home/jaja-agent"
  local repo_url="https://github.com/GoldenStiv-Fedora/jaja-agent.git"

  echo "üì¶ –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞..."
  
  if [[ ! -d "$install_dir/.git" ]]; then
    sudo mkdir -p "$install_dir"
    sudo chown "$(whoami):$(whoami)" "$install_dir"
    
    if ! git clone --branch main "$repo_url" "$install_dir"; then
      error "–ù–µ —É–¥–∞–ª–æ—Å—å –∫–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π"
    fi
    success "–ü—Ä–æ–µ–∫—Ç —Å–∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω –≤ $install_dir"
  else
    warning "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è $install_dir —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –∫–æ–ø–∏—è."
  fi
}

# ----------------------------------------------
# –§—É–Ω–∫—Ü–∏—è: run_install
# –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –ó–∞–ø—É—Å–∫ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
# –û–ø–∏—Å–∞–Ω–∏–µ:
#   –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞ –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç install.sh
# ----------------------------------------------
run_install() {
  local install_dir="/home/jaja-agent"
  
  echo "üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏..."
  cd "$install_dir" || error "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ $install_dir"
  
  if [[ ! -f "./install.sh" ]]; then
    error "–û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (install.sh) –Ω–µ –Ω–∞–π–¥–µ–Ω"
  fi
  
  bash ./install.sh || error "–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è install.sh"
}

# ----------------------------------------------
# –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
# –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –≤—Å–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ bootstrap
# ----------------------------------------------
main() {
  echo -e "\n=== JAJA Agent Bootstrap ==="
  echo "–í–µ—Ä—Å–∏—è: 1.0.0"
  echo "–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –ü–µ—Ä–≤–∏—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∏—Å—Ç–µ–º—ã –¥–ª—è JAJA Agent"
  echo "======================================"
  
  check_dependencies
  setup_config
  clone_project
  run_install
  
  echo -e "\n‚úÖ –ë—É—Ç—Å—Ç—Ä–∞–ø –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
  echo "JAJA Agent –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ"
}

# –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
main
